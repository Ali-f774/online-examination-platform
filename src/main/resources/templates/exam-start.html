<!DOCTYPE html>
<html th:lang="${#locale.language}"
      th:attr="dir=#{dir}">
<head>
    <meta charset="UTF-8">
    <title>Exam</title>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/global.css">
</head>
<body onload="loadAnswer()">
<div class="w-100 jce df" style="font-size: 30px"><a class="lang" style="border: solid white 2px;padding: 5px" href="#" onclick="back();return false;" th:text="#{back}"></a><a class="lang" href="#" onclick="updateLang('fa');return false;" >فارسی</a>|<a class="lang" href="#" onclick="updateLang('en');return false;">English</a></div>
<div class="w-100 jcc df" style="font-size: 30px" id="timer"></div>
<div class="w-100 df jcc " >
    <form id="form" class="w-50 dg jcc">
        <input type="hidden" id="id" th:value="${question.id()}">
        <input type="hidden" id="num" th:value="${questionNumber}">
        <input type="hidden" id="size" th:value="${questionsSize}">
        <input type="hidden" id="type" th:value="${question.type()}">
        <input type="hidden" id="studentId" th:value="${studentId}">
        <input type="hidden" id="examId" th:value="${question.examId()}">
        <input type="hidden" id="endTime" th:value="${endTime}">

        <div id="quillHTML" class="w-100" th:utext="${question.question()}">
        </div>
        <div th:if="${question.type().toString() == 'MULTI_CHOICE'}">
            <input type="hidden" id="startIndex" th:value="${question.choices().size()}">
            <div id="choices">
                <div th:each="choice : ${question.choices()}" class="choice df jcc"  style="border: solid white 2px">
                    <h2 class="choice-text" th:value="${choice}" th:text="${choice}"></h2>
                    <input type="radio" name="correctChoice" th:value="${choice}">
                </div>
            </div>
        </div>
        <div th:if="${question.type().toString() == 'ESSAY'}">
            <textarea cols="30" rows="10" id="answer">
            </textarea>
        </div>
    </form>
</div>
<div class="w-100 df jcc">
    <button class="sb" id="previous" th:text="#{previous}"></button>
    <button class="sb" id="next" th:text="#{next}"></button>
    <button class="sb" style="display: none" id="register" th:text="#{register.answers}"></button>
</div>
<div id="error-div" class="w-100 df jcc ed">

</div>
</body>
<script>
    const errorDiv = document.getElementById("error-div");
    const answerArea = document.getElementById("answer");
    const previous = document.getElementById("previous");
    const next = document.getElementById("next");
    const register = document.getElementById("register");
    const questionId = document.getElementById("id").value;
    const studentId = document.getElementById("studentId").value;
    const examId = document.getElementById("examId").value;
    const questionNumber = document.getElementById("num").value;
    const questionsSize = document.getElementById("size").value;
    const type = document.getElementById("type").value;
    async function loadAnswer(){
        timerElement.innerHTML =
            `<h2 style="border: solid white 2px;padding: 5px">00:00</h2>`;
        if (parseInt(questionNumber) < 2){
            previous.style.display = "none";
        }
        if (parseInt(questionNumber) === parseInt(questionsSize)){
            next.style.display = "none";
            register.style.display = "inline-block"
        }

        fetch(`/api/v1/student/student?studentId=${studentId}&questionId=${questionId}`)
            .then(async response => await response.json())
            .then(res => {
              if (type === "ESSAY"){
                  answerArea.value = res.answer;
              }else if (type === "MULTI_CHOICE"){
                  let elements = Array.from(document.querySelectorAll('input[name="correctChoice"]'));
                  for (let i = 0; i < elements.length; i++) {
                      if (elements[i].value === res.answer) {
                          elements[i].checked = true;
                          break;
                      }
                  }
              }
            })
    }
    next.addEventListener("click",function () {
        const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
        let answer;
        if (type === "MULTI_CHOICE") {
            answer = correctChoice?correctChoice.value:"";
        }
        if (type === "ESSAY") {
            answer = answerArea.value;
        }
        let data = {questionId,studentId,answer}
        fetch("/api/v1/student",{
                method: "POST",
                credentials: 'include',
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify(data)
            }
        ).then(async res => {
            if (!res.ok) {
                const errorBody = await res.json();

                throw new Error(errorBody.message)
            }

            window.location.replace(`/student/exam-start?id=${examId}&number=${parseInt(questionNumber)+1}`)
        })
            .catch(error => {
                errorDiv.innerText = error.message
            })

    })
    previous.addEventListener("click",function () {
        const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
        let answer;
        if (type === "MULTI_CHOICE") {
            answer = correctChoice?correctChoice.value:"";
        }
        if (type === "ESSAY") {
            answer = answerArea.value;
        }
        let data = {questionId,studentId,answer}
        fetch("/api/v1/student",{
                method: "POST",
                credentials: 'include',
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify(data)
            }
        ).then(async res => {
            if (!res.ok) {
                const errorBody = await res.json();

                throw new Error(errorBody.message)
            }

            window.location.replace(`/student/exam-start?id=${examId}&number=${parseInt(questionNumber)-1}`)
        })
            .catch(error => {
                errorDiv.innerText = error.message
            })

    })
    async function finish() {
        const correctChoice = document.querySelector('input[name="correctChoice"]:checked');
        let answer;
        if (type === "MULTI_CHOICE") {
            answer = correctChoice?correctChoice.value:"";
        }
        if (type === "ESSAY") {
            answer = answerArea.value;
        }
        let data = {questionId,studentId,answer}
        fetch("/api/v1/student",{
                method: "POST",
                credentials: 'include',
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify(data)
            }
        ).then(async res => {
            if (!res.ok) {
                const errorBody = await res.json();

                throw new Error(errorBody.message)
            }
            await fetch(`/api/v1/student/register`,{
                method: "POST",
                credentials: 'include',
                headers:{
                    "Content-Type":"application/json"
                },
                body:JSON.stringify({"id":examId,"studentId":studentId})
            }).then(async res => {
                if (!res.ok) {
                    const errorBody = await res.json();

                    throw new Error(errorBody.message)
                }

                window.location.replace(`/home`)
            })
                .catch(error => {
                    errorDiv.innerText = error.message
                })

        })
            .catch(error => {
                errorDiv.innerText = error.message
            })


    }
    register.addEventListener("click",finish);

    function back(){
        window.location.replace(`/student/course-exams?id=`+courseId)
    }
    function updateLang (lang){
        let url = new URL(window.location.href)
        url.searchParams.set('lang',lang);
        window.location.href = url.toString();
    }
    const timerElement = document.getElementById('timer');
    const endTime = Number(document.getElementById("endTime").value);

    const timer = setInterval(() => {
        const now = Date.now();
        const remaining = endTime - now;

        if (remaining <= 0) {
            clearInterval(timer);
            finish();
            return;
        }

        const minutes = Math.floor(remaining / 1000 / 60);
        const seconds = Math.floor(remaining / 1000) % 60;

        timerElement.innerHTML =
            `<h2 style="border: solid white 2px;padding: 5px">${minutes}:${seconds.toString().padStart(2, '0')}</h2>`;
    }, 1000);

</script>
</html>